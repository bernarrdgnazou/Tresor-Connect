{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec titre et boutons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-file-invoice me-2"></i>Mes Mandats
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Mes Mandats</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('deposer_mandat') }}" class="btn btn-success">
                <i class="fas fa-plus-circle me-1"></i>Nouveau Mandat
            </a>
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#filtersCollapse" aria-expanded="false">
                <i class="fas fa-filter me-1"></i>Filtres
                {% if filtres_actifs %}
                <span class="badge bg-primary ms-1">{{ filtres_actifs|length }}</span>
                {% endif %}
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Exporter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exporterDonnees('csv')">CSV</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exporterDonnees('excel')">Excel</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exporterDonnees('pdf')">PDF</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Panneau de filtres avancés -->
    <div class="collapse mb-4" id="filtersCollapse">
        <div class="card card-body">
            <form method="get" class="row g-3" id="filterForm">
                <div class="col-md-3">
                    <label for="statut" class="form-label">Statut</label>
                    <select name="statut" id="statut" class="form-select">
                        <option value="">Tous les statuts</option>
                        {% for statut in tous_statuts %}
                        <option value="{{ statut.name }}" 
                                {% if request.args.get('statut') == statut.name %}selected{% endif %}>
                            {{ statut.value }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="fournisseur_id" class="form-label">Fournisseur</label>
                    <select name="fournisseur_id" id="fournisseur_id" class="form-select">
                        <option value="">Tous les fournisseurs</option>
                        {% for fournisseur in fournisseurs %}
                        <option value="{{ fournisseur.id }}" 
                                {% if request.args.get('fournisseur_id')|int == fournisseur.id %}selected{% endif %}>
                            {{ fournisseur.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="date_debut" class="form-label">Date début</label>
                    <input type="date" name="date_debut" id="date_debut" 
                           value="{{ request.args.get('date_debut') }}" class="form-control">
                </div>
                
                <div class="col-md-2">
                    <label for="date_fin" class="form-label">Date fin</label>
                    <input type="date" name="date_fin" id="date_fin" 
                           value="{{ request.args.get('date_fin') }}" class="form-control">
                </div>
                
                <div class="col-md-2">
                    <label for="montant_min" class="form-label">Montant min</label>
                    <input type="number" name="montant_min" id="montant_min" 
                           value="{{ request.args.get('montant_min') }}" placeholder="0" 
                           class="form-control" step="0.01">
                </div>
                
                <div class="col-md-2">
                    <label for="montant_max" class="form-label">Montant max</label>
                    <input type="number" name="montant_max" id="montant_max" 
                           value="{{ request.args.get('montant_max') }}" placeholder="10000" 
                           class="form-control" step="0.01">
                </div>
                
                <div class="col-md-2">
                    <label for="tri" class="form-label">Trier par</label>
                    <select name="tri" id="tri" class="form-select">
                        <option value="date_desc" {% if request.args.get('tri') == 'date_desc' %}selected{% endif %}>Date ↓</option>
                        <option value="date_asc" {% if request.args.get('tri') == 'date_asc' %}selected{% endif %}>Date ↑</option>
                        <option value="montant_desc" {% if request.args.get('tri') == 'montant_desc' %}selected{% endif %}>Montant ↓</option>
                        <option value="montant_asc" {% if request.args.get('tri') == 'montant_asc' %}selected{% endif %}>Montant ↑</option>
                        <option value="reference" {% if request.args.get('tri') == 'reference' %}selected{% endif %}>Référence</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Options</label>
                    <div class="form-check">
                        <input type="checkbox" name="urgence_only" id="urgence_only" 
                               class="form-check-input" {% if request.args.get('urgence_only') %}checked{% endif %}>
                        <label for="urgence_only" class="form-check-label">Urgents seulement</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="correction_requise" id="correction_requise" 
                               class="form-check-input" {% if request.args.get('correction_requise') %}checked{% endif %}>
                        <label for="correction_requise" class="form-check-label">Corrections requises</label>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="d-flex gap-2 align-items-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Appliquer les filtres
                        </button>
                        <a href="{{ url_for('liste_mandats') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Réinitialiser
                        </a>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="autoRefresh" checked>
                            <label for="autoRefresh" class="form-check-label small">Actualisation auto</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Résumé des filtres actifs -->
    {% if filtres_actifs %}
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <div>
            <strong><i class="fas fa-filter me-1"></i>Filtres actifs :</strong>
            {% for filtre in filtres_actifs %}
            <span class="badge bg-primary ms-2">{{ filtre }}</span>
            {% endfor %}
            <small class="text-muted ms-2">({{ mandats.total }} résultat(s))</small>
        </div>
        <a href="{{ url_for('liste_mandats') }}" class="btn btn-sm btn-outline-info">
            <i class="fas fa-times me-1"></i>Tout effacer
        </a>
    </div>
    {% endif %}

    <!-- Cartes de statistiques rapides -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-3">
                <div class="stat-card">
                    <span class="stat-number">{{ mandats.total }}</span>
                    <span class="stat-label">Total</span>
                </div>
                {% for stat in stats_filtrees %}
                <div class="stat-card stat-{{ stat.color }}">
                    <span class="stat-number">{{ stat.count }}</span>
                    <span class="stat-label">{{ stat.nom }}</span>
                </div>
                {% endfor %}
                {% if mandats.total > 0 %}
                <div class="stat-card stat-light">
                    <span class="stat-number">{{ f"{montant_total} €" }}</span>
                    <span class="stat-label">Montant total</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tableau des mandats -->
    <div class="card shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Liste des mandats
                <small class="text-muted">(Page {{ mandats.page }}/{{ mandats.pages }})</small>
            </h5>
            <div class="d-flex align-items-center">
                <span class="me-3 small text-muted">
                    Affichage {{ mandats.per_page * (mandats.page - 1) + 1 }}-
                    {{ mandats.per_page * mandats.page if mandats.per_page * mandats.page < mandats.total else mandats.total }}
                    sur {{ mandats.total }}
                </span>
                <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                    <option value="10" {% if mandats.per_page == 10 %}selected{% endif %}>10/page</option>
                    <option value="25" {% if mandats.per_page == 25 %}selected{% endif %}>25/page</option>
                    <option value="50" {% if mandats.per_page == 50 %}selected{% endif %}>50/page</option>
                    <option value="100" {% if mandats.per_page == 100 %}selected{% endif %}>100/page</option>
                </select>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tableMandats">
                    <thead class="table-light">
                        <tr>
                            <th width="30">
                                <input type="checkbox" id="selectAll" class="form-check-input">
                            </th>
                            <th width="120">Référence</th>
                            <th>Fournisseur</th>
                            <th width="120">Montant TTC</th>
                            <th width="140">Statut</th>
                            <th width="110">Date dépôt</th>
                            <th width="110">Échéance</th>
                            <th width="150">Dernière action</th>
                            <th width="100" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mandat in mandats.items %}
                        <tr class="mandat-row {% if mandat.urgence %}table-warning{% endif %} 
                            {% if mandat.correction_requise %}table-danger{% endif %}" 
                            data-mandat-id="{{ mandat.id }}">
                            <td>
                                <input type="checkbox" name="mandat_ids" value="{{ mandat.id }}" 
                                       class="form-check-input mandat-checkbox">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <strong class="mandat-reference">{{ mandat.reference }}</strong>
                                    <div class="ms-1">
                                        {% if mandat.urgence %}
                                        <span class="badge bg-danger badge-sm" data-bs-toggle="tooltip" 
                                              title="Mandat urgent">
                                            <i class="fas fa-exclamation"></i>
                                        </span>
                                        {% endif %}
                                        {% if mandat.pieces_jointes %}
                                        <span class="badge bg-info badge-sm" data-bs-toggle="tooltip" 
                                              title="{{ mandat.pieces_jointes|length }} pièce(s) jointe(s)">
                                            <i class="fas fa-paperclip"></i>
                                        </span>
                                        {% endif %}
                                        {% if mandat.correction_requise %}
                                        <span class="badge bg-warning badge-sm" data-bs-toggle="tooltip" 
                                              title="Correction requise">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-light rounded me-2">
                                        <i class="fas fa-building text-muted"></i>
                                    </div>
                                    <div>
                                        <strong class="d-block">{{ mandat.fournisseur.nom }}</strong>
                                        <small class="text-muted">{{ mandat.fournisseur.email|truncate(25) }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <strong class="text-primary">{{ "{:,.2f} €".format(mandat.montant) }}</strong>
                                {% if mandat.montant_ht %}
                                <br>
                                <small class="text-muted">HT: {{ "{:,.2f} €".format(mandat.montant_ht) }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ mandat.statut.color }} badge-lg">
                                    <i class="fas fa-{{ get_statut_icon(mandat.statut) }} me-1"></i>
                                    {{ mandat.statut.value }}
                                </span>
                                {% if mandat.correction_requise %}
                                <div class="mt-1">
                                    <small class="text-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Correction requise
                                    </small>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small">
                                    <div>{{ mandat.date_depot.strftime('%d/%m/%Y') }}</div>
                                    <div class="text-muted">{{ mandat.date_depot.strftime('%H:%M') }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    <div>{{ mandat.date_echeance.strftime('%d/%m/%Y') }}</div>
                                    {% set jours_restants = (mandat.date_echeance - now).days %}
                                    {% if jours_restants < 0 %}
                                    <span class="badge bg-danger badge-sm">Dépassée</span>
                                    {% elif jours_restants <= 3 %}
                                    <span class="badge bg-warning badge-sm">J-{{ jours_restants }}</span>
                                    {% else %}
                                    <span class="text-muted">J-{{ jours_restants }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if mandat.historique %}
                                <div class="small">
                                    <div class="text-truncate" style="max-width: 150px;" 
                                         data-bs-toggle="tooltip" title="{{ mandat.historique[-1].action }}">
                                        {{ mandat.historique[-1].action|truncate(20) }}
                                    </div>
                                    <div class="text-muted">{{ mandat.historique[-1].date_action|time_ago }}</div>
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('detail_mandat', mandat_id=mandat.id) }}" 
                                       class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if mandat.statut.name in ['EN_ATTENTE', 'EN_COURS'] %}
                                    <a href="{{ url_for('modifier_mandat', mandat_id=mandat.id) }}" 
                                       class="btn btn-outline-warning" data-bs-toggle="tooltip" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {% if mandat.correction_requise %}
                                    <a href="{{ url_for('corriger_mandat', mandat_id=mandat.id) }}" 
                                       class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Corriger">
                                        <i class="fas fa-wrench"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Aucun mandat trouvé</h5>
                                    <p class="text-muted mb-4">
                                        {% if filtres_actifs %}
                                        Aucun mandat ne correspond à vos critères de recherche.
                                        {% else %}
                                        Vous n'avez pas encore déposé de mandat.
                                        {% endif %}
                                    </p>
                                    <a href="{{ url_for('deposer_mandat') }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>Déposer votre premier mandat
                                    </a>
                                    {% if filtres_actifs %}
                                    <a href="{{ url_for('liste_mandats') }}" class="btn btn-outline-secondary ms-2">
                                        <i class="fas fa-times me-1"></i>Effacer les filtres
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pied de tableau avec pagination -->
        {% if mandats.pages > 1 %}
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div class="small text-muted">
                    Page {{ mandats.page }} sur {{ mandats.pages }} - 
                    {{ mandats.total }} mandat(s) au total
                </div>
                
                <nav aria-label="Pagination">
                    <ul class="pagination justify-content-center mb-0">
                        <!-- Premier -->
                        <li class="page-item {% if not mandats.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('liste_mandats', page=1, **request_args) }}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        
                        <!-- Précédent -->
                        <li class="page-item {% if not mandats.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('liste_mandats', page=mandats.prev_num, **request_args) }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>

                        <!-- Pages -->
                        {% for page_num in mandats.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == mandats.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('liste_mandats', page=page_num, **request_args) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        <!-- Suivant -->
                        <li class="page-item {% if not mandats.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('liste_mandats', page=mandats.next_num, **request_args) }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>

                        <!-- Dernier -->
                        <li class="page-item {% if not mandats.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('liste_mandats', page=mandats.pages, **request_args) }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="small text-muted">
                    <select class="form-select form-select-sm d-inline-block w-auto" 
                            onchange="window.location.href = '{{ url_for('liste_mandats', **request_args) }}&page=' + this.value">
                        {% for p in range(1, mandats.pages + 1) %}
                        <option value="{{ p }}" {% if p == mandats.page %}selected{% endif %}>{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions groupées -->
    <div class="mt-3 p-3 bg-light rounded d-none" id="actionsGroupees">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="nbSelectionnes" class="fw-bold">0 mandat(s) sélectionné(s)</span>
                <small class="text-muted ms-2" id="montantTotalSelection"></small>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                        onclick="exporterSelection()">
                    <i class="fas fa-download me-1"></i>Exporter la sélection
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" 
                        onclick="dupliquerSelection()">
                    <i class="fas fa-copy me-1"></i>Dupliquer
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="supprimerSelection()">
                    <i class="fas fa-trash me-1"></i>Supprimer
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                        onclick="deselectionnerTout()">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Export -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exporter les données</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sélectionnez le format d'export :</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-success" onclick="exporterFormat('csv')">
                        <i class="fas fa-file-csv me-2"></i>CSV (Excel)
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="exporterFormat('excel')">
                        <i class="fas fa-file-excel me-2"></i>Excel
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="exporterFormat('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let selectedMandats = new Set();
let autoRefreshInterval;

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    initSelection();
    initTooltips();
    initAutoRefresh();
    initTableInteractions();
});

// Gestion de la sélection multiple
function initSelection() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.mandat-checkbox');
    const actionsGroupees = document.getElementById('actionsGroupees');

    // Sélection/désélection globale
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            updateSelection(checkbox);
        });
        toggleActionsGroupees();
    });

    // Gestion individuelle
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelection(this);
            // Met à jour la case "Tout sélectionner"
            selectAll.checked = [...checkboxes].every(cb => cb.checked);
            toggleActionsGroupees();
        });
    });

    function updateSelection(checkbox) {
        const mandatId = checkbox.value;
        if (checkbox.checked) {
            selectedMandats.add(mandatId);
        } else {
            selectedMandats.delete(mandatId);
        }
    }

    function toggleActionsGroupees() {
        const nbSelectionnes = selectedMandats.size;
        const nbSpan = document.getElementById('nbSelectionnes');
        const montantSpan = document.getElementById('montantTotalSelection');
        
        nbSpan.textContent = `${nbSelectionnes} mandat(s) sélectionné(s)`;
        
        // Calcul du montant total sélectionné
        let total = 0;
        selectedMandats.forEach(id => {
            const montantText = document.querySelector(`tr[data-mandat-id="${id}"] td:nth-child(4)`).textContent;
            const montant = parseFloat(montantText.replace(/[^\d,]/g, '').replace(',', '.'));
            if (!isNaN(montant)) total += montant;
        });
        
        montantSpan.textContent = total > 0 ? `Total: ${total.toLocaleString('fr-FR', {style: 'currency', currency: 'EUR'})}` : '';
        
        if (nbSelectionnes > 0) {
            actionsGroupees.classList.remove('d-none');
        } else {
            actionsGroupees.classList.add('d-none');
        }
    }
}

// Tooltips Bootstrap
function initTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Actualisation automatique
function initAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    
    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    startAutoRefresh();
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        // Vérifier les changements de statut
        updateStatuts();
    }, 30000); // Toutes les 30 secondes
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

// Mise à jour des statuts
async function updateStatuts() {
    const rows = document.querySelectorAll('.mandat-row');
    for (const row of rows) {
        const mandatId = row.dataset.mandatId;
        try {
            const response = await fetch(`/api/mandat/${mandatId}/statut`);
            const data = await response.json();
            
            if (!data.error) {
                const badge = row.querySelector('.badge');
                if (badge) {
                    badge.textContent = data.statut;
                    badge.className = `badge bg-${data.color} badge-lg`;
                }
            }
        } catch (error) {
            console.error('Erreur mise à jour statut:', error);
        }
    }
}

// Interactions table
function initTableInteractions() {
    // Clic sur une ligne (sauf cases à cocher)
    document.querySelectorAll('.mandat-row').forEach(row => {
        row.addEventListener('click', (e) => {
            if (!e.target.closest('input[type="checkbox"]') && !e.target.closest('.btn')) {
                const mandatId = row.dataset.mandatId;
                window.location.href = `/agent/mandat/${mandatId}`;
            }
        });
    });
}

// Fonctions d'export
function exporterDonnees(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.open(`{{ url_for('liste_mandats') }}?${params.toString()}`, '_blank');
}

function exporterSelection() {
    if (selectedMandats.size === 0) {
        alert('Veuillez sélectionner au moins un mandat');
        return;
    }
    
    const mandatIds = Array.from(selectedMandats).join(',');
    const format = prompt('Format d\'export (csv/excel/pdf):', 'csv');
    
    if (format && ['csv', 'excel', 'pdf'].includes(format)) {
        window.open(`/agent/export/mandats?ids=${mandatIds}&format=${format}`, '_blank');
    }
}

function exporterFormat(format) {
    exporterDonnees(format);
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
}

function dupliquerSelection() {
    if (selectedMandats.size === 0) {
        alert('Veuillez sélectionner au moins un mandat');
        return;
    }
    
    if (confirm(`Dupliquer ${selectedMandats.size} mandat(s) ?`)) {
        // Implémenter la duplication
        alert('Fonction de duplication à implémenter');
    }
}

function supprimerSelection() {
    if (selectedMandats.size === 0) {
        alert('Veuillez sélectionner au moins un mandat');
        return;
    }
    
    if (confirm(`Supprimer définitivement ${selectedMandats.size} mandat(s) ? Cette action est irréversible.`)) {
        // Implémenter la suppression
        fetch('/agent/mandats/supprimer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mandat_ids: Array.from(selectedMandats) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}

function deselectionnerTout() {
    selectedMandats.clear();
    document.querySelectorAll('.mandat-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    document.getElementById('actionsGroupees').classList.add('d-none');
}

function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Recherche en temps réel
document.getElementById('searchInput')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.mandat-row').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>

<style>
.stat-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px 20px;
    text-align: center;
    min-width: 100px;
}
.stat-number {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #495057;
}
.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}
.stat-primary { border-left: 4px solid #0d6efd; }
.stat-success { border-left: 4px solid #198754; }
.stat-warning { border-left: 4px solid #ffc107; }
.stat-danger { border-left: 4px solid #dc3545; }
.stat-info { border-left: 4px solid #0dcaf0; }
.stat-light { border-left: 4px solid #f8f9fa; }

.badge-sm {
    font-size: 0.7em;
    padding: 0.2em 0.4em;
}
.badge-lg {
    font-size: 0.85em;
    padding: 0.35em 0.65em;
}

.mandat-row {
    cursor: pointer;
    transition: background-color 0.15s ease;
}
.mandat-row:hover {
    background-color: #f8f9fa !important;
}

.avatar-sm {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.empty-state {
    padding: 3rem 1rem;
    text-align: center;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.pagination {
    margin-bottom: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.85rem;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}