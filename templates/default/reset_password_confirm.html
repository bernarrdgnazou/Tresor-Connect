{% extends "base.html" %}
{% block title %}Nouveau mot de passe - TRÉSOR CONNECT{% endblock %}

{% block style %}
<link href="{{ url_for('static', filename='css/forms.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="login-container">
  <div class="login-card">
    <h2 class="login-title"><i class="fas fa-lock"></i> Nouveau mot de passe</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <p class="text-muted text-center">
      Veuillez entrer votre nouveau mot de passe.
    </p>

    <form action="{{ url_for('reset_password_token', token=token) }}" method="post" autocomplete="off">
      {{ form.hidden_tag() }}
      
      <!-- Nouveau mot de passe -->
      <div class="form-group">
        <label for="password"><i class="fas fa-lock"></i> Nouveau mot de passe</label>
        {{ form.password(class="form-control", id="password", placeholder="********") }}
        {% if form.password.errors %}
          <div class="text-danger">
            {% for error in form.password.errors %}
              <small>{{ error }}</small>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Confirmation mot de passe -->
      <div class="form-group">
        <label for="confirm_password"><i class="fas fa-lock"></i> Confirmer le mot de passe</label>
        {{ form.confirm_password(class="form-control", id="confirm_password", placeholder="********") }}
        {% if form.confirm_password.errors %}
          <div class="text-danger">
            {% for error in form.confirm_password.errors %}
              <small>{{ error }}</small>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Bouton -->
      <button type="submit" class="btn-login">
        <i class="fas fa-save me-2"></i>Réinitialiser le mot de passe
      </button>

      <!-- Lien retour -->
      <p class="signup-link mt-3 text-center">
        <a href="{{ url_for('login') }}">
          <i class="fas fa-arrow-left me-1"></i>Retour à la connexion
        </a>
      </p>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Gestion de la visibilité des mots de passe
  function setupPasswordToggle(passwordFieldId) {
    const passwordField = document.getElementById(passwordFieldId);
    const togglePassword = document.createElement('span');
    togglePassword.innerHTML = '<i class="fas fa-eye"></i>';
    togglePassword.className = 'password-toggle';
    togglePassword.style.cursor = 'pointer';
    togglePassword.style.position = 'absolute';
    togglePassword.style.right = '10px';
    togglePassword.style.top = '50%';
    togglePassword.style.transform = 'translateY(-50%)';
    
    passwordField.parentElement.style.position = 'relative';
    passwordField.parentElement.appendChild(togglePassword);
    
    togglePassword.addEventListener('click', function() {
      const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordField.setAttribute('type', type);
      this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
  }
  
  setupPasswordToggle('password');
  setupPasswordToggle('confirm_password');
  
  // Validation en temps réel
  const passwordField = document.getElementById('password');
  const confirmPasswordField = document.getElementById('confirm_password');
  const submitButton = document.querySelector('.btn-login');
  
  function validateForm() {
    const passwordValid = passwordField.value.length >= 6;
    const confirmValid = passwordField.value === confirmPasswordField.value;
    
    const formValid = passwordValid && confirmValid;
    
    submitButton.disabled = !formValid;
    submitButton.style.opacity = formValid ? '1' : '0.6';
    
    // Feedback visuel
    highlightField(passwordField, passwordValid);
    highlightField(confirmPasswordField, confirmValid);
  }
  
  function highlightField(field, isValid) {
    if (field.value === '') {
      field.style.borderColor = '#e1e5e9';
    } else {
      field.style.borderColor = isValid ? '#28a745' : '#dc3545';
    }
  }
  
  passwordField.addEventListener('input', validateForm);
  confirmPasswordField.addEventListener('input', validateForm);
  validateForm();
});
</script>
{% endblock %}