<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}{% endblock %}</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static', filename='css/base.css') }}" rel="stylesheet">
  {% block style %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Header -->
  <header class="custom-header py-3">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-dark">
        
        <!-- Brand -->
        <a class="navbar-brand" href="{{ url_for('home') }}">
          <i class="fas me-2"></i>TRÉSOR DIVO CONNECT
          <span class="live-dot ms-2"></span>
        </a>

        <!-- Mobile toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Main navigation -->
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            {% if current_user.is_authenticated %}
              <!-- Navigation pour utilisateurs connectés -->
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                  <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
              </li>
              
              {% if current_user.role.value == 'agent' %}
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'deposer_mandat' %}active{% endif %}" href="{{ url_for('deposer_mandat') }}">
                  <i class="fas fa-plus-circle me-1"></i>Déposer Mandat
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'mes_mandats' %}active{% endif %}" href="{{ url_for('mes_mandats') }}">
                  <i class="fas fa-file-invoice me-1"></i>Mes Mandats
                </a>
              </li>
              {% endif %}
              
              {% if current_user.role.value == 'fournisseur' %}
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'mes_mandats' %}active{% endif %}" href="{{ url_for('mes_mandats') }}">
                  <i class="fas fa-file-invoice-dollar me-1"></i>Mes Mandats
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'historique_paiements' %}active{% endif %}" href="{{ url_for('historique_paiements') }}">
                  <i class="fas fa-history me-1"></i>Historique
                </a>
              </li>
              {% endif %}
              
              {% if current_user.role.value == 'tresorier' %}
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'mandats_a_traiter' %}active{% endif %}" href="{{ url_for('mandats_a_traiter') }}">
                  <i class="fas fa-tasks me-1"></i>Mandats à Traiter
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'mes_mandats' %}active{% endif %}" href="{{ url_for('mes_mandats') }}">
                  <i class="fas fa-list-alt me-1"></i>Tous les Mandats
                </a>
              </li>
              {% endif %}
              
              {% if current_user.role.value == 'admin' %}
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'admin_database' %}active{% endif %}" href="{{ url_for('admin_database') }}">
                  <i class="fas fa-database me-1"></i>Base de Données
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'admin_users' %}active{% endif %}" href="{{ url_for('admin_users') }}">
                  <i class="fas fa-users-cog me-1"></i>Utilisateurs
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'admin_reports' %}active{% endif %}" href="{{ url_for('admin_reports') }}">
                  <i class="fas fa-chart-pie me-1"></i>Rapports
                </a>
              </li>
              {% endif %}
              
              <!-- Menu utilisateur -->
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                  <i class="fas fa-user-circle me-1"></i>
                  {{ current_user.nom_complet }}
                  <span class="badge bg-{% if current_user.role.value == 'admin' %}danger{% elif current_user.role.value == 'agent' %}primary{% elif current_user.role.value == 'tresorier' %}warning{% else %}success{% endif %} ms-1">
                    {{ current_user.role.value|title }}
                  </span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="{{ url_for('profil') }}"><i class="fas fa-user-edit me-2"></i>Mon Profil</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('statistiques') }}"><i class="fas fa-chart-bar me-2"></i>Statistiques</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{{ url_for('inscription') }}"><i class="fas fa-sign-out-alt me-2"></i>Déconnexion</a></li>
                </ul>
              </li>
              
              <!-- Notifications -->
              <li class="nav-item dropdown">
                <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
                  <i class="fas fa-bell"></i>
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown">
                  <li><h6 class="dropdown-header"><i class="fas fa-bell me-2"></i>Notifications</h6></li>
                  <li><div class="dropdown-item-text" id="notifications-list">
                    <div class="text-center py-3">
                      <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Chargement...</span>
                      </div>
                      Chargement des notifications...
                    </div>
                  </div></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-center" href="{{ url_for('notifications') }}"><i class="fas fa-list me-2"></i>Voir toutes</a></li>
                </ul>
              </li>
              
            {% else %}
              <!-- Navigation pour utilisateurs non connectés -->
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint.endswith('home') %}active{% endif %}" href="{{ url_for('home') }}">
                  <i class="fas fa-home me-1"></i>Accueil
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint.endswith('fonction') %}active{% endif %}" href="{{ url_for('fonction') }}">
                  <i class="fas fa-cogs me-1"></i>Fonctionnement
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint.endswith('traitement') %}active{% endif %}" href="{{ url_for('traitement') }}">
                  <i class="fas fa-play-circle me-1"></i>Traitement
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint.endswith('faq') %}active{% endif %}" href="{{ url_for('faq') }}">
                  <i class="fas fa-question-circle me-1"></i>FAQ
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.endpoint.endswith('connexion') %}active{% endif %}" href="{{ url_for('connexion') }}">
                  <i class="fas fa-sign-in-alt me-1"></i>Aller plus loin
                </a>
              </li>
            {% endif %}
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- Messages Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Main content -->
  <main class="flex-grow-1">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="footer-custom text-white pt-5 pb-3">
    <div class="container">
      <div class="row gy-4">
        
        <!-- Logo + Description -->
        <div class="col-lg-4 col-md-6">
          <h4 class="fw-bold mb-3">
            <i class="fas fa-gem text-warning me-2"></i>TRÉSOR CONNECT
          </h4>
          <p class="small">
            Une plateforme intelligente pour la gestion et la modernisation du Trésor Public. 
            Transparence, innovation et efficacité pour chaque citoyen.
          </p>
          <div class="d-flex gap-3 mt-3">
            <a href="#" class="text-white fs-5"><i class="fab fa-facebook"></i></a>
            <a href="#" class="text-white fs-5"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-white fs-5"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>

        <!-- Liens rapides -->
        <div class="col-lg-2 col-md-6">
          <h5 class="text-uppercase mb-3"><i class="fas fa-link me-2"></i>Navigation</h5>
          <ul class="list-unstyled">
            <li><a href="{{ url_for('home') }}" class="footer-link"><i class="fas fa-home me-2"></i>Accueil</a></li>
            <li><a href="{{ url_for('fonction') }}" class="footer-link"><i class="fas fa-cogs me-2"></i>Fonctionnement</a></li>
            <li><a href="{{ url_for('traitement') }}" class="footer-link"><i class="fas fa-play-circle me-2"></i>Traitement</a></li>
            <li><a href="{{ url_for('faq') }}" class="footer-link"><i class="fas fa-question-circle me-2"></i>FAQ</a></li>
          </ul>
        </div>

        <!-- Régions -->
        <div class="col-lg-3 col-md-6">
          <h5 class="text-uppercase mb-3"><i class="fas fa-map-marker-alt me-2"></i>Trésoreries régionales</h5>
          <ul class="list-unstyled">
            <li><a href="#" class="footer-link"><i class="fas fa-building me-2"></i>Trésorerie de Hiré</a></li>
            <li><a href="#" class="footer-link"><i class="fas fa-building me-2"></i>Trésorerie de Guitry</a></li>
            <li><a href="#" class="footer-link"><i class="fas fa-building me-2"></i>Trésorerie de Lakota</a></li>
          </ul>
        </div>

        <!-- Contact -->
        <div class="col-lg-3 col-md-6">
          <h5 class="text-uppercase mb-3"><i class="fas fa-envelope me-2"></i>Contact</h5>
          <p class="small mb-1"><i class="fas fa-map-marker-alt me-2 text-warning"></i> Abidjan, Côte d'Ivoire</p>
          <p class="small mb-1"><i class="fas fa-envelope me-2 text-warning"></i> support@tresorconnect.ci</p>
          <p class="small"><i class="fas fa-phone me-2 text-warning"></i> +225 07 00 00 00</p>
        </div>
      </div>

      <!-- Bas de page -->
      <hr class="border-light">
      <div class="text-center small">
        <i class="fas fa-copyright me-1"></i>2025 TRÉSOR CONNECT - Tous droits réservés
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JS -->
  <script src="{{ url_for('static', filename='js/base.js') }}"></script>
  
  <!-- Notifications JS -->
  <script>
    // Gestion des notifications
    document.addEventListener('DOMContentLoaded', function() {
      // Charger les notifications non lues
      if (document.getElementById('notifications-list')) {
        fetch('{{ url_for("api_notifications_non_lues") }}')
          .then(response => response.json())
          .then(notifications => {
            const notificationsList = document.getElementById('notifications-list');
            const notificationBadge = document.querySelector('.badge.bg-danger');
            
            if (notifications.length > 0) {
              notificationBadge.textContent = notifications.length;
              notificationBadge.classList.remove('d-none');
              
              notificationsList.innerHTML = '';
              notifications.forEach(notif => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'dropdown-item-text';
                notificationItem.innerHTML = `
                  <small class="text-${notif.type}"><i class="fas fa-bell me-1"></i>${notif.message}</small><br>
                  <small class="text-muted"><i class="fas fa-clock me-1"></i>${notif.date_creation}</small>
                `;
                notificationItem.style.cursor = 'pointer';
                notificationItem.onclick = function() {
                  fetch(`/api/notifications/marquer-lue/${notif.id}`, {method: 'POST'})
                    .then(() => {
                      window.location.reload();
                    });
                };
                notificationsList.appendChild(notificationItem);
              });
            } else {
              notificationsList.innerHTML = '<div class="text-center py-2 text-muted"><i class="fas fa-bell-slash me-1"></i>Aucune notification</div>';
            }
          });
      }
      
      // Auto-dismiss des alertes après 5 secondes
      setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        });
      }, 5000);
    });
  </script>
  
  {% block scripts %}{% endblock %}
</body>
</html>